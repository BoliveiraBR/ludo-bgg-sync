###################################################################################################
#### Instalação do Google Chrome para Puppeteer no AWS Elastic Beanstalk
#### Este arquivo instala Chrome e suas dependências necessárias para usar Puppeteer
###################################################################################################

commands:
  01_install_chrome_repo:
    command: |
      if [ ! -f /etc/yum.repos.d/google-chrome.repo ]; then
        echo "Installing Google Chrome repository..."
        cat > /etc/yum.repos.d/google-chrome.repo << 'EOF'
[google-chrome]
name=google-chrome
baseurl=http://dl.google.com/linux/chrome/rpm/stable/$basearch
enabled=1
gpgcheck=1
gpgkey=https://dl-ssl.google.com/linux/linux_signing_key.pub
EOF
      fi
    ignoreErrors: false

  02_install_chrome:
    command: |
      echo "Installing Google Chrome and dependencies..."
      yum update -y
      yum install -y google-chrome-stable
      yum install -y liberation-fonts liberation-narrow-fonts liberation-serif-fonts
      yum install -y xorg-x11-fonts-Type1 xorg-x11-fonts-misc
      yum install -y alsa-lib atk cairo cups-libs dbus-glib GConf2
      yum install -y gtk3 libXcomposite libXcursor libXdamage libXext
      yum install -y libXi libXrandr libXScrnSaver libXtst pango
      yum install -y xorg-x11-fonts-100dpi xorg-x11-fonts-75dpi
      yum install -y xorg-x11-utils xorg-x11-fonts-cyrillic
      yum install -y xorg-x11-fonts-Type1 xorg-x11-fonts-misc
      yum install -y nss atk at-spi2-atk
    ignoreErrors: false

  03_verify_chrome_install:
    command: |
      echo "Verifying Chrome installation..."
      /usr/bin/google-chrome-stable --version || echo "Chrome installation failed"
      ls -la /usr/bin/google-chrome* || echo "Chrome binaries not found"
      which google-chrome-stable || echo "google-chrome-stable not in PATH"
    ignoreErrors: true

  04_set_chrome_permissions:
    command: |
      echo "Setting Chrome permissions..."
      chmod +x /usr/bin/google-chrome-stable
      chown root:root /usr/bin/google-chrome-stable
      # Criar link simbólico se necessário
      ln -sf /usr/bin/google-chrome-stable /usr/bin/chromium-browser || true
      ln -sf /usr/bin/google-chrome-stable /usr/bin/chromium || true
    ignoreErrors: true

option_settings:
  aws:elasticbeanstalk:application:environment:
    NODE_ENV: production
    PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true
    PUPPETEER_EXECUTABLE_PATH: /usr/bin/google-chrome-stable

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/post/99_install_chrome_deps.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      echo "Post-deploy: Verifying Chrome installation for Puppeteer..."
      
      # Verificar se Chrome está instalado e funcionando
      if command -v google-chrome-stable >/dev/null 2>&1; then
        echo "✅ Chrome found: $(google-chrome-stable --version)"
        
        # Testar se Chrome consegue inicializar
        timeout 10s google-chrome-stable --headless --disable-gpu --no-sandbox --version >/dev/null 2>&1
        if [ $? -eq 0 ]; then
          echo "✅ Chrome headless test passed"
        else
          echo "⚠️ Chrome headless test failed"
        fi
      else
        echo "❌ Chrome not found after installation"
      fi
      
      # Verificar dependências do sistema
      echo "Checking system dependencies..."
      rpm -qa | grep -E "(liberation-fonts|nss|alsa-lib|atk|cairo|cups-libs|dbus-glib|gtk3)" | head -10
      
      # Definir variável de ambiente para a aplicação
      export PUPPETEER_EXECUTABLE_PATH="/usr/bin/google-chrome-stable"
      
      echo "Chrome setup completed."

  "/opt/elasticbeanstalk/hooks/appdeploy/post/98_puppeteer_setup.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      echo "Setting up Puppeteer environment..."
      
      # Criar diretório de cache do Puppeteer se não existir
      mkdir -p /home/webapp/.cache/puppeteer
      chown -R webapp:webapp /home/webapp/.cache
      
      # Configurar permissões para /tmp (usado pelo Chrome)
      chmod 1777 /tmp
      
      # Verificar espaço em disco
      df -h
      
      echo "Puppeteer setup completed."